
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Adopting nullability annotations - miqu.me</title>
  <meta name="author" content="Miguel Angel Quiñones">

   
  <meta name="description" content="Software engineering thoughts">
  
  <meta name="keywords" content="">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://miqu.me/blog/2015/04/17/adopting-nullability-annotations">
  <link href="/favicon.png" rel="icon">
  <link href='https://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="miqu.me" type="application/atom+xml">
  <script src="/js/jquery.js"></script>
  <script src="/js/bootstrap-collapse.js"></script>
  <script src="/js/modernizr-2.0.js"></script>
  <script src="/js/octopress.js" type="text/javascript"></script>
  <script src="/js/application.js"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <div class="navbar navbar-inverse navbar-static-top">
  	<div class="navbar-inner">
  	  <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".navbar-responsive-collapse">
          <span class="fui-menu-24"></span>
        </a>
  	  	<div class="nav-collapse collapse navbar-responsive-collapse" style="height:0;">
  	      <ul class="nav">
    
        <li ><a href="/">Blog</a></li>
    
        <li ><a href="/about/">Who?</a></li>
    
        <li ><a href="/games/">Games</a></li>
    
        <li ><a href="/speaking/">Speaking</a></li>
    
</ul>

<ul class="nav pull-right">
    
    <li><a href="https://github.com/DarthMike" title="Github Profile"><i class="icon-github-sign social-navbar"></i></a></li>
    
    
    
    <li><a href="https://linkedin.com/in/miguelquinon" title="Linkedin Profile"><i class="icon-linkedin-sign social-navbar"></i></a></li>
    
    
    <li><a href="https://twitter.com/@miguelquinon" title="Twitter Profile"><i class="icon-twitter-sign social-navbar"></i></a></li>
    
    
    
    

    
    <li><a href="mailto:miguel@miqu.me" title="Email"><i class="icon-envelope social-navbar"></i></a></li>
    
</ul>

  	    </div>
  	  </div>
  	</div>
  </div>
  <div class="container" id="main">
      <div class="row-fluid">
        <div id="content">
          <div>
<article class="hentry" role="article">
  

  <header>
  <div class="jumbotron">
    Adopting Nullability Annotations
	<h5>








  



<i class="icon-calendar-empty"></i> <time datetime="2015-04-17T22:39:03+00:00" pubdate data-updated="true">17 Apr 2015</time></h5>
  </div>
</header>
  <div class="row-fluid">
    <div class="span12">
      <p>Apple introduced nullability annotations to Objective-C compiler from <a href="https://developer.apple.com/swift/blog/?id=25">XCode 6.3</a>. I was really surprised by this change, and welcomed it with open arms when I saw the release notes. My first thought was: Objective-C is learning from Swift! I want to share my 2 cents on this new annotation and what it means for more modern Objective-C code.</p>

<!-- more -->


<h1>The new annotations</h1>

<p>There&rsquo;s not much to these new annotations. You can check all the details from Apple&rsquo;s <a href="https://developer.apple.com/swift/blog/?id=25">blog post</a>, but I will summarise here:</p>

<ul>
<li>There&rsquo;s two new annotations for (obviously) pointer types which can be nil or NULL: <code>__nullable</code> and <code>__nonnull</code></li>
<li>These annotations can be used anywhere you can use the C <code>const</code> keyword</li>
<li>Within method and property declarations, a non-underscore annotation can be used (<code>nullable</code> and <code>nonnull</code>)</li>
<li>You can annotate whole parts of a file to assume non null, with <code>NS_ASSUME_NONNULL_BEGIN</code> <code>NS_ASSUME_NONNULL_END</code></li>
</ul>


<p>That&rsquo;s it.</p>

<h1>What&rsquo;s the catch?</h1>

<p>These annotations allow you to express your intent when defining an interface. It makes APIs clearer and reduce the need for documentation specifying nil behaviour. When used from Swift code, it allows the interface to &lsquo;transform&rsquo; as needed to express nullability in Swift terms; That is no more implicitly unwrapped optionals and declared non-nil references, and simple optionals.</p>

<p>But you need to understand that the language (Objective-C) hasn&rsquo;t changed, and that these annotations don&rsquo;t change the runtime behaviour of the code at all. In other words: The generated code with and without annotations is the same.</p>

<p>So the compiler will generate warnings when the API is misused. <em>Compiler. Is. Always. Clever.</em> Is it in this case?</p>

<h2>Indirect nil values</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// Your object</span>
</span><span class='line'>
</span><span class='line'><span class="n">NS_ASSUME_NONNULL_BEGIN</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> : <span class="bp">UIViewController</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">copy</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="n">nonNullString</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="n">NS_ASSUME_NONNULL_END</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Then you use it as:</span>
</span><span class='line'><span class="bp">NSString</span> <span class="o">*</span><span class="n">aString</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithFormat</span><span class="p">:</span><span class="s">@&quot;helloworld %.1f&quot;</span><span class="p">,</span><span class="mf">1.0</span><span class="p">];</span>
</span><span class='line'><span class="n">aString</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'><span class="n">controller</span><span class="p">.</span><span class="n">nonNullString</span> <span class="o">=</span> <span class="n">aString</span><span class="p">;</span> <span class="c1">// No warning. Generated code does not change.</span>
</span><span class='line'><span class="n">controller</span><span class="p">.</span><span class="n">nonNullString</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span> <span class="c1">// Warning</span>
</span></code></pre></td></tr></table></div></figure>


<p>Compiling the previous code, generates a warning for a nonnull property only when you set a <strong>direct</strong> nil value. If you set an <strong>indirect</strong> nil value, the compiler happily accepts this without any warning. This may surprise you at first, so you need to be aware of this.</p>

<p>I think it could improve though: <a href="http://openradar.appspot.com/20596086">rdar://problem/20596086</a>.</p>

<h2>Weak properties</h2>

<p>The typical delegate pattern in Objective-C, annotated:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NS_ASSUME_NONNULL_BEGIN</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">ViewController</span> : <span class="bp">UIViewController</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Note it&#39;s a weak property and compiler does not complain.</span>
</span><span class='line'><span class="c1">// Anyway the property will be nullified by the runtime as it has always been. Annotations don&#39;t affect generated code.</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">weak</span><span class="p">)</span> <span class="kt">id</span> <span class="n">delegate</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="n">NS_ASSUME_NONNULL_END</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Using it:</span>
</span><span class='line'><span class="kt">id</span> <span class="n">delegate</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSObject</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="n">ViewController</span> <span class="o">*</span><span class="n">controller</span> <span class="o">=</span> <span class="p">[[</span><span class="n">ViewController</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithNibName</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">bundle</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="n">controller</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">delegate</span><span class="p">;</span>
</span><span class='line'><span class="n">delegate</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>  <span class="c1">// controller.delegate is nil as expected. Generated code does not change.</span>
</span><span class='line'><span class="n">controller</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span> <span class="c1">// Generates warning at compile time</span>
</span></code></pre></td></tr></table></div></figure>


<p>So as you can see, you can annotate a weak pointer as <code>nonnull</code> but obviously it is a nullable value. The generated code is not changed and runtime behaviour remains the same. But the compiler (incorrectly) warns you only when you set a direct value to nil.</p>

<p>I think this could also improve: <a href="http://openradar.appspot.com/20596408">rdar://problem/20596408</a>.</p>

<h1>Adopting nullability for existing projects</h1>

<p>As with any language or compiler changes, adopting these new annotations can be tedious, specially for large codebases. I think the strategy to follow is to incrementally annotate APIs for different sections of your code.</p>

<p>If you build and application, the lower layers and the models are the place to start annotating right away. All UI code can wait and can be annotated at a later time. Be also aware that even Apple&rsquo;s headers are not annotated yet. With the notable exception of ResearchKit. Expect this to change this summer ;)</p>

<p>If you are building a framework, my guess is that the best place to start annotating is the API. Then working out the annotations to the internal code is a work that can progressively be done in smaller chunks.</p>

<h1>Conclusion</h1>

<p>Nullability annotations are a very important addition to Objective-C as a language. There are some minor &lsquo;Gotchas&rsquo; and an adoption work which is very manual. But I think that every iOS Developer should start using these, and modernizing the code as soon as possible.</p>

<p>Be aware that annotations don&rsquo;t turn Objective-C nil semantics into a Swift-like optional. It&rsquo;s just a tool to clarify intentions and compiler does not do too much checking for you.</p>

<p>Well, you still have time till <a href="https://developer.apple.com/wwdc/">next set of breaking changes</a>.</p>

    </div>
  </div>



  <footer>
    <hr>
    
    <div class="row-fluid">
      
      <div class="span6">
        <p class="meta">
        
        



  <a href="/blog/categories/code-style/"><span class="badge">code style</span></a>

  <a href="/blog/categories/ios/"><span class="badge">ios</span></a>

  <a href="/blog/categories/objective-c/"><span class="badge">objective-c</span></a>




        </p>
      </div>
      
      <div class="span6 social-sharing">
        <div class="sharing">
  <div class="addthis_toolbox addthis_default_style ">
  
  
  <a class="addthis_button_tweet"></a>
  
  
  <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>

      </div>
      
      
    </div>
    
    <div class="row-fluid">
      <div class="span12">
        <p class="meta">
          
            <a class="basic-alignment left" href="/blog/2015/04/14/exfat-with-raspberry-pi-continued/" title="Previous Post: exFat with Raspberry Pi (continued)">&laquo; exFat with Raspberry Pi (continued)</a>
          
          
            <a class="basic-alignment right" href="/blog/2015/05/27/fragmentation/" title="Next Post: Fragmentation">Fragmentation &raquo;</a>
          
        </p>
      </div>
    </div>
  </footer>
</article>

</div>



        </div>
      </div>
      <div class="row-fluid">
        <footer class="footer-page" role="contentinfo">
          <p>
  Copyright &copy; 2018 - Miguel Angel Quiñones -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> - Theme by <a href="http://alexgaribay.com">Alex Garibay</a>
</p>


        </footer>
      </div>
  </div>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'https://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
